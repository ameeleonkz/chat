# üõ† Backend Service: Chat API (Next.js API + PostgreSQL + Socket.IO)

## 1. –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

Backend-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–µ–∞–ª–∏–∑—É–µ—Ç REST –∏ WebSocket API –¥–ª—è –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —á–∞—Ç–∞. –û–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é, –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –≤–µ–¥—ë—Ç —É—á–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –æ–±–º–µ–Ω —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ —á–µ—Ä–µ–∑ Socket.IO.

–°–µ—Ä–≤–∏—Å —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ç —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞, –∏–º–µ–µ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ PostgreSQL-–±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (–æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å).

---

## 2. –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç       | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è                         |
|------------------|------------------------------------|
| –Ø–¥—Ä–æ —Å–µ—Ä–≤–∏—Å–∞     | Next.js API Routes (TypeScript)    |
| –í–µ–±-—Å–æ–∫–µ—Ç—ã       | socket.io (v4+)                    |
| –ë–î               | PostgreSQL 15                      |
| –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è      | JSON Web Tokens (JWT)              |
| –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ      | bcrypt                             |
| –í–∞–ª–∏–¥–∞—Ü–∏—è        | zod / joi / custom                 |

---

## 3. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

```
backend/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ pages/api/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/               # login, register
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ users/              # user listing
‚îÇ   ‚îú‚îÄ‚îÄ socket/                 # WebSocket handlers
‚îÇ   ‚îú‚îÄ‚îÄ lib/                    # jwt, prisma, hashing
‚îÇ   ‚îî‚îÄ‚îÄ middleware/             # auth guards, utils
‚îú‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ .env
```

---

## 4. REST API

### 4.1 –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

| –ú–µ—Ç–æ–¥   | –ü—É—Ç—å             | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                | –¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞                 |
|---------|------------------|---------------------------|------------------------------|
| `POST`  | `/api/auth/login`    | –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è             | `{ username, password }`     |
| `POST`  | `/api/auth/register` | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è                | `{ username, password }`     |

### 4.2 –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏

| –ú–µ—Ç–æ–¥   | –ü—É—Ç—å             | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                |
|---------|------------------|---------------------------|
| `GET`   | `/api/users`         | –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π |

---

## 5. WebSocket API (Socket.IO)

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

–ö–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è —Å –ø–µ—Ä–µ–¥–∞—á–µ–π JWT —Ç–æ–∫–µ–Ω–∞:

```ts
const socket = io(SOCKET_URL, {
  auth: {
    token: jwt,
  }
});
```

### –°–µ—Ä–≤–µ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

```ts
io.use((socket, next) => {
  const token = socket.handshake.auth.token;
  try {
    const payload = jwt.verify(token, JWT_SECRET);
    socket.user = payload;
    next();
  } catch (err) {
    next(new Error('Unauthorized'));
  }
});
```

### –°–æ–±—ã—Ç–∏—è

| –°–æ–±—ã—Ç–∏–µ      | –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å | –ü–∞—Ä–∞–º–µ—Ç—Ä—ã                         | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                  |
|--------------|-------------|-----------------------------------|-----------------------------|
| `message`    | –∫–ª–∏–µ–Ω—Ç      | `{ userId, content }`             | –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è   |
| `message`    | —Å–µ—Ä–≤–µ—Ä      | `{ id, userId, content, timestamp }` | –®–∏—Ä–æ–∫–æ–≤–µ—â–∞—Ç–µ–ª—å–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞  |

---

## 6. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü

- `users`: id, username, password_hash, created_at
- `messages`: id, user_id (FK), content, created_at

–ú–∏–≥—Ä–∞—Ü–∏–∏ –∏ —Å—Ö–µ–º–∞ –æ–ø–∏—Å–∞–Ω—ã —á–µ—Ä–µ–∑ Prisma.

---

## 7. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)

```
DATABASE_URL=postgresql://user:pass@db:5432/chat
JWT_SECRET=some_long_secret_key
```

---

## 8. Docker –∏ –∑–∞–ø—É—Å–∫

–°–µ—Ä–≤–∏—Å —É–ø–∞–∫–æ–≤–∞–Ω –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `Dockerfile`, –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è –≤ `docker-compose`:

```yaml
services:
  backend:
    build: ./backend
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - JWT_SECRET=${JWT_SECRET}
    ports:
      - "3001:3000"
```

### –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫:

```bash
docker compose up -d --build
```

---

## 9. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

- ‚ú® –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (admin, moderator)
- üìÑ –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º (Zod / Yup)
- üîê Refresh —Ç–æ–∫–µ–Ω—ã, —Ä–æ—Ç–∞—Ü–∏—è
- üîç –ü–æ–∏—Å–∫ –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º
- üìä REST-–º–µ—Ç—Ä–∏–∫–∏, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, audit trail
- üß† –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å LLM-—Å–µ—Ä–≤–µ—Ä–æ–º (—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è, —Ä–µ–∑—é–º–µ)

---
